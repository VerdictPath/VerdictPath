import React, { useState } from 'react';
import {
  View,
  Text,
  StyleSheet,
  ScrollView,
  TouchableOpacity,
  TextInput,
  Alert,
  Platform
} from 'react-native';
import { theme } from '../styles/theme';

// Updated pricing structure - granular tiers based on client count
// Variable markup strategy: Higher % for small firms (easier upgrade), lower % for large (volume)
const LAW_FIRM_PRICING = {
  tiers: [
    { 
      name: 'Solo/Shingle',
      min: 1,
      max: 24,
      standard: {
        monthly: 45,
        annual: 486,
        features: [
          'Up to 24 clients',
          'üìç Interactive Roadmap',
          'üîî Push Notifications to Clients',
          'üìä Basic Analytics Dashboard',
          'üîí Evidence Locker Access'
        ]
      },
      premium: {
        monthly: 59,
        annual: 637,
        features: [
          'Everything in Basic',
          'üè• Medical Hub (COMING SOON)',
          'üìà Premium Analytics Dashboard',
          'üí∞ Disbursements to Client Unlocked (COMING SOON)',
          'üè• Disbursements to Medical Providers Unlocked (COMING SOON)'
        ]
      },
      description: 'Perfect for solo practitioners'
    },
    { 
      name: 'Boutique',
      min: 25,
      max: 49,
      standard: {
        monthly: 80,
        annual: 864,
        features: [
          'Up to 49 clients',
          'üìç Interactive Roadmap',
          'üîî Push Notifications to Clients',
          'üìä Basic Analytics Dashboard',
          'üîí Evidence Locker Access'
        ]
      },
      premium: {
        monthly: 104,
        annual: 1123,
        features: [
          'Everything in Basic',
          'üè• Medical Hub (COMING SOON)',
          'üìà Premium Analytics Dashboard',
          'üí∞ Disbursements to Client Unlocked (COMING SOON)',
          'üè• Disbursements to Medical Providers Unlocked (COMING SOON)'
        ]
      },
      description: 'Small specialized firms'
    },
    { 
      name: 'Small Firm',
      min: 50,
      max: 99,
      standard: {
        monthly: 140,
        annual: 1512,
        features: [
          'Up to 99 clients',
          'üìç Interactive Roadmap',
          'üîî Push Notifications to Clients',
          'üìä Basic Analytics Dashboard',
          'üîí Evidence Locker Access'
        ]
      },
      premium: {
        monthly: 175,
        annual: 1890,
        features: [
          'Everything in Basic',
          'üè• Medical Hub (COMING SOON)',
          'üìà Premium Analytics Dashboard',
          'üí∞ Disbursements to Client Unlocked (COMING SOON)',
          'üè• Disbursements to Medical Providers Unlocked (COMING SOON)'
        ]
      },
      description: 'Growing practice'
    },
    { 
      name: 'Medium-Small',
      min: 100,
      max: 199,
      standard: {
        monthly: 250,
        annual: 2700,
        features: [
          'Up to 199 clients',
          'üìç Interactive Roadmap',
          'üîî Push Notifications to Clients',
          'üìä Basic Analytics Dashboard',
          'üîí Evidence Locker Access'
        ]
      },
      premium: {
        monthly: 300,
        annual: 3240,
        features: [
          'Everything in Basic',
          'üè• Medical Hub (COMING SOON)',
          'üìà Premium Analytics Dashboard',
          'üí∞ Disbursements to Client Unlocked (COMING SOON)',
          'üè• Disbursements to Medical Providers Unlocked (COMING SOON)'
        ]
      },
      description: 'Established regional firm'
    },
    { 
      name: 'Medium',
      min: 200,
      max: 349,
      standard: {
        monthly: 420,
        annual: 4536,
        features: [
          'Up to 349 clients',
          'üìç Interactive Roadmap',
          'üîî Push Notifications to Clients',
          'üìä Basic Analytics Dashboard',
          'üîí Evidence Locker Access'
        ]
      },
      premium: {
        monthly: 500,
        annual: 5400,
        features: [
          'Everything in Basic',
          'üè• Medical Hub (COMING SOON)',
          'üìà Premium Analytics Dashboard',
          'üí∞ Disbursements to Client Unlocked (COMING SOON)',
          'üè• Disbursements to Medical Providers Unlocked (COMING SOON)'
        ]
      },
      description: 'Multi-location practice'
    },
    { 
      name: 'Medium-Large',
      min: 350,
      max: 499,
      standard: {
        monthly: 630,
        annual: 6804,
        features: [
          'Up to 499 clients',
          'üìç Interactive Roadmap',
          'üîî Push Notifications to Clients',
          'üìä Basic Analytics Dashboard',
          'üîí Evidence Locker Access'
        ]
      },
      premium: {
        monthly: 750,
        annual: 8100,
        features: [
          'Everything in Basic',
          'üè• Medical Hub (COMING SOON)',
          'üìà Premium Analytics Dashboard',
          'üí∞ Disbursements to Client Unlocked (COMING SOON)',
          'üè• Disbursements to Medical Providers Unlocked (COMING SOON)'
        ]
      },
      description: 'Major regional firm'
    },
    { 
      name: 'Large',
      min: 500,
      max: 749,
      standard: {
        monthly: 1000,
        annual: 10800,
        features: [
          'Up to 749 clients',
          'üìç Interactive Roadmap',
          'üîî Push Notifications to Clients',
          'üìä Basic Analytics Dashboard',
          'üîí Evidence Locker Access'
        ]
      },
      premium: {
        monthly: 1200,
        annual: 12960,
        features: [
          'Everything in Basic',
          'üè• Medical Hub (COMING SOON)',
          'üìà Premium Analytics Dashboard',
          'üí∞ Disbursements to Client Unlocked (COMING SOON)',
          'üè• Disbursements to Medical Providers Unlocked (COMING SOON)'
        ]
      },
      description: 'Large multi-state firm'
    },
    { 
      name: 'Enterprise',
      min: 750,
      max: Infinity,
      standard: {
        monthly: 1500,
        annual: 16200,
        features: [
          'Unlimited clients',
          'üìç Interactive Roadmap',
          'üîî Push Notifications to Clients',
          'üìä Basic Analytics Dashboard',
          'üîí Evidence Locker Access'
        ]
      },
      premium: {
        monthly: 1800,
        annual: 19440,
        features: [
          'Everything in Basic',
          'üè• Medical Hub (COMING SOON)',
          'üìà Premium Analytics Dashboard',
          'üí∞ Disbursements to Client Unlocked (COMING SOON)',
          'üè• Disbursements to Medical Providers Unlocked (COMING SOON)'
        ]
      },
      description: 'National firm'
    }
  ]
};

const INDIVIDUAL_PRICING = {
  free: {
    name: 'Free',
    monthly: 0,
    annual: 0,
    features: ['Access to roadmap', 'Basic notifications', 'Document storage (500MB)']
  },
  basic: {
    name: 'Basic',
    monthly: 9.99,
    annual: 99.99,
    features: ['Everything in Free', 'Unlimited storage', 'Priority support', 'No ads']
  },
  premium: {
    name: 'Premium',
    monthly: 19.99,
    annual: 199.99,
    features: ['Everything in Basic', 'AI document analysis', 'Video consultations', 'Premium content']
  }
};

const SubscriptionSelectionScreen = ({ userType, onSelectSubscription, onNavigate }) => {
  const [clientCount, setClientCount] = useState('');
  const [billingPeriod, setBillingPeriod] = useState('monthly');
  const [planType, setPlanType] = useState('standard'); // 'standard' or 'premium'
  const [selectedTier, setSelectedTier] = useState(null);
  const [showCalculator, setShowCalculator] = useState(userType === 'lawfirm');

  // Calculate pricing tier based on client count
  const calculateTier = (count) => {
    const numClients = parseInt(count);
    if (isNaN(numClients) || numClients < 1) return null;
    
    return LAW_FIRM_PRICING.tiers.find(
      tier => numClients >= tier.min && numClients <= tier.max
    );
  };

  const currentTier = calculateTier(clientCount);

  const getPrice = (tier) => {
    if (!tier) return 0;
    const pricing = tier[planType]; // Get standard or premium pricing
    return billingPeriod === 'monthly' ? pricing.monthly : pricing.annual;
  };

  const getPerClientCost = (tier, count) => {
    if (!tier || !count) return 0;
    const price = getPrice(tier);
    return (price / parseInt(count)).toFixed(2);
  };

  const getAnnualSavings = (tier) => {
    if (!tier) return 0;
    const pricing = tier[planType];
    return ((pricing.monthly * 12) - pricing.annual).toFixed(2);
  };

  const handleSelectPlan = (plan, tierData = null) => {
    if (userType === 'lawfirm') {
      if (!clientCount || !currentTier) {
        Alert.alert('Client Count Required', 'Please enter your number of clients to continue');
        return;
      }

      const planLabel = planType === 'premium' ? 'Premium' : 'Standard';

      Alert.alert(
        'Confirm Selection',
        `Select ${currentTier.name} ${planLabel} plan?\n\n` +
        `Price: $${getPrice(currentTier)}/${billingPeriod === 'monthly' ? 'month' : 'year'}\n` +
        `Clients: ${clientCount}\n` +
        `Per client: $${getPerClientCost(currentTier, clientCount)}`,
        [
          { text: 'Cancel', style: 'cancel' },
          {
            text: 'Continue',
            onPress: () => {
              onSelectSubscription(
                currentTier.name.toLowerCase().replace(/[^a-z]/g, ''),
                {
                  clientCount: parseInt(clientCount),
                  tierName: currentTier.name,
                  billingPeriod: billingPeriod,
                  planType: planType
                }
              );
            }
          }
        ]
      );
    } else {
      // Individual user
      const tierData = INDIVIDUAL_PRICING[plan];
      const price = billingPeriod === 'monthly' ? tierData.monthly : tierData.annual;
      
      if (plan === 'free') {
        onSelectSubscription('free', null);
      } else {
        Alert.alert(
          'Confirm Selection',
          `Select ${tierData.name} plan?\n\n` +
          `Price: $${price}/${billingPeriod === 'monthly' ? 'month' : 'year'}`,
          [
            { text: 'Cancel', style: 'cancel' },
            {
              text: 'Continue',
              onPress: () => {
                onSelectSubscription(plan, { billingPeriod: billingPeriod });
              }
            }
          ]
        );
      }
    }
  };

  const renderLawFirmPricing = () => {
    return (
      <View style={styles.lawFirmContainer}>
        {/* Calculator */}
        <View style={styles.calculator}>
          <Text style={styles.calculatorTitle}>üíº Calculate Your Price</Text>
          <Text style={styles.calculatorSubtitle}>
            Simple, transparent pricing based on your client count
          </Text>

          <View style={styles.inputGroup}>
            <Text style={styles.inputLabel}>How many clients do you have?</Text>
            <TextInput
              style={styles.input}
              keyboardType="number-pad"
              value={clientCount}
              onChangeText={setClientCount}
              placeholder="Enter number of clients"
              placeholderTextColor="#999"
            />
          </View>

          {/* Plan Type Selector (Standard vs Premium) */}
          <View style={styles.planTypeSelector}>
            <Text style={styles.planTypeSelectorLabel}>Select Plan Type:</Text>
            <View style={styles.planTypeButtons}>
              <TouchableOpacity
                style={[
                  styles.planTypeButton,
                  planType === 'standard' && styles.planTypeButtonActive
                ]}
                onPress={() => setPlanType('standard')}
              >
                <Text style={[
                  styles.planTypeButtonText,
                  planType === 'standard' && styles.planTypeButtonTextActive
                ]}>
                  Standard
                </Text>
                <Text style={styles.planTypeButtonSubtext}>Essential features</Text>
              </TouchableOpacity>
              
              <TouchableOpacity
                style={[
                  styles.planTypeButton,
                  planType === 'premium' && styles.planTypeButtonActive
                ]}
                onPress={() => setPlanType('premium')}
              >
                <View style={styles.premiumBadgeSmall}>
                  <Text style={styles.premiumBadgeText}>‚≠ê PREMIUM</Text>
                </View>
                <Text style={[
                  styles.planTypeButtonText,
                  planType === 'premium' && styles.planTypeButtonTextActive
                ]}>
                  Premium
                </Text>
                <Text style={styles.planTypeButtonSubtext}>+19-31% - Advanced features</Text>
              </TouchableOpacity>
            </View>
          </View>

          {/* Billing Period Toggle */}
          <View style={styles.billingToggle}>
            <TouchableOpacity
              style={[
                styles.toggleButton,
                billingPeriod === 'monthly' && styles.toggleActive
              ]}
              onPress={() => setBillingPeriod('monthly')}
            >
              <Text style={[
                styles.toggleText,
                billingPeriod === 'monthly' && styles.toggleTextActive
              ]}>
                Monthly
              </Text>
            </TouchableOpacity>
            
            <TouchableOpacity
              style={[
                styles.toggleButton,
                billingPeriod === 'annual' && styles.toggleActive
              ]}
              onPress={() => setBillingPeriod('annual')}
            >
              <Text style={[
                styles.toggleText,
                billingPeriod === 'annual' && styles.toggleTextActive
              ]}>
                Annual
              </Text>
              <View style={styles.savingsBadge}>
                <Text style={styles.savingsText}>Save 10%</Text>
              </View>
            </TouchableOpacity>
          </View>

          {/* Results */}
          {currentTier && (
            <View style={styles.results}>
              <View style={styles.tierBadgeContainer}>
                <View style={styles.tierBadge}>
                  <Text style={styles.tierName}>{currentTier.name}</Text>
                  <Text style={styles.tierRange}>
                    {currentTier.min}-{currentTier.max === Infinity ? '999+' : currentTier.max} clients
                  </Text>
                </View>
                {planType === 'premium' && (
                  <View style={styles.premiumPill}>
                    <Text style={styles.premiumPillText}>‚≠ê PREMIUM</Text>
                  </View>
                )}
              </View>

              <Text style={styles.tierDescription}>{currentTier.description}</Text>

              <View style={styles.priceDisplay}>
                <Text style={styles.priceAmount}>
                  ${getPrice(currentTier)}
                </Text>
                <Text style={styles.pricePeriod}>
                  /{billingPeriod === 'monthly' ? 'mo' : 'yr'}
                </Text>
              </View>

              <View style={styles.priceDetails}>
                <Text style={styles.perClientText}>
                  Just ${getPerClientCost(currentTier, clientCount)} per client
                </Text>
                {billingPeriod === 'annual' && (
                  <Text style={styles.savingsHighlight}>
                    üí∞ Save ${getAnnualSavings(currentTier)}/year
                  </Text>
                )}
              </View>

              {/* Features */}
              <View style={styles.featuresContainer}>
                <Text style={styles.featuresTitle}>
                  {planType === 'premium' ? '‚≠ê Premium Features:' : 'üì¶ Basic Features:'}
                </Text>
                {currentTier[planType].features.map((feature, index) => (
                  <View key={index} style={styles.featureRow}>
                    <Text style={styles.featureCheck}>‚úì</Text>
                    <Text style={styles.featureText}>{feature}</Text>
                  </View>
                ))}
              </View>

              {/* Select Button */}
              <TouchableOpacity
                style={[
                  styles.selectButton,
                  planType === 'premium' && styles.selectButtonPremium
                ]}
                onPress={() => handleSelectPlan('lawfirm', currentTier)}
              >
                <Text style={styles.selectButtonText}>
                  Select {currentTier.name} {planType === 'premium' ? 'Premium' : 'Standard'}
                </Text>
              </TouchableOpacity>

              {/* Comparison hint */}
              {planType === 'standard' && (
                <TouchableOpacity
                  style={styles.upgradeHint}
                  onPress={() => setPlanType('premium')}
                >
                  <Text style={styles.upgradeHintText}>
                    ‚≠ê Upgrade to Premium for advanced features
                  </Text>
                </TouchableOpacity>
              )}

              {/* Next tier hint */}
              {currentTier.max !== Infinity && (
                <Text style={styles.nextTierHint}>
                  üí° At {currentTier.max + 1} clients, you'll upgrade to {
                    LAW_FIRM_PRICING.tiers[
                      LAW_FIRM_PRICING.tiers.indexOf(currentTier) + 1
                    ]?.name
                  }
                </Text>
              )}
            </View>
          )}

          {/* Pricing table for reference */}
          <View style={styles.pricingTableContainer}>
            <View style={styles.pricingTableHeader}>
              <Text style={styles.pricingTableTitle}>All Tiers at a Glance</Text>
              <View style={styles.pricingTableToggle}>
                <TouchableOpacity
                  style={[
                    styles.tableToggleButton,
                    planType === 'standard' && styles.tableToggleActive
                  ]}
                  onPress={() => setPlanType('standard')}
                >
                  <Text style={[
                    styles.tableToggleText,
                    planType === 'standard' && styles.tableToggleTextActive
                  ]}>Standard</Text>
                </TouchableOpacity>
                <TouchableOpacity
                  style={[
                    styles.tableToggleButton,
                    planType === 'premium' && styles.tableToggleActive
                  ]}
                  onPress={() => setPlanType('premium')}
                >
                  <Text style={[
                    styles.tableToggleText,
                    planType === 'premium' && styles.tableToggleTextActive
                  ]}>Premium</Text>
                </TouchableOpacity>
              </View>
            </View>
            <ScrollView horizontal showsHorizontalScrollIndicator={false}>
              <View style={styles.pricingTable}>
                {LAW_FIRM_PRICING.tiers.map((tier, index) => {
                  const pricing = tier[planType];
                  const price = billingPeriod === 'monthly' ? pricing.monthly : pricing.annual;
                  
                  return (
                    <View
                      key={index}
                      style={[
                        styles.pricingTableColumn,
                        currentTier?.name === tier.name && styles.pricingTableColumnActive
                      ]}
                    >
                      <Text style={styles.tableColumnName}>{tier.name}</Text>
                      <Text style={styles.tableColumnRange}>
                        {tier.min}-{tier.max === Infinity ? '999+' : tier.max}
                      </Text>
                      <Text style={styles.tableColumnPrice}>
                        ${price}
                      </Text>
                      <Text style={styles.tableColumnPeriod}>
                        /{billingPeriod === 'monthly' ? 'mo' : 'yr'}
                      </Text>
                    </View>
                  );
                })}
              </View>
            </ScrollView>
          </View>
        </View>

        {/* Additional revenue info */}
        <View style={styles.additionalRevenueBox}>
          <Text style={styles.revenueBoxTitle}>üí∞ Unlock Disbursements with Premium</Text>
          <Text style={styles.revenueBoxText}>
            Premium plan unlocks the ability to process settlement disbursements through the app. 
            Earn $200 per transaction when you pay clients and medical providers.
          </Text>
          <Text style={styles.revenueBoxExample}>
            Example: 10 settlements/month = $2,000 additional revenue
          </Text>
          <View style={styles.comingSoonBadge}>
            <Text style={styles.comingSoonText}>üöÄ COMING SOON</Text>
          </View>
        </View>
      </View>
    );
  };

  const renderIndividualPricing = () => {
    return (
      <View style={styles.individualContainer}>
        <Text style={styles.title}>Choose Your Plan</Text>
        <Text style={styles.subtitle}>
          Navigate your legal journey with confidence
        </Text>

        {/* Billing Period Toggle */}
        <View style={styles.billingToggle}>
          <TouchableOpacity
            style={[
              styles.toggleButton,
              billingPeriod === 'monthly' && styles.toggleActive
            ]}
            onPress={() => setBillingPeriod('monthly')}
          >
            <Text style={[
              styles.toggleText,
              billingPeriod === 'monthly' && styles.toggleTextActive
            ]}>
              Monthly
            </Text>
          </TouchableOpacity>
          
          <TouchableOpacity
            style={[
              styles.toggleButton,
              billingPeriod === 'annual' && styles.toggleActive
            ]}
            onPress={() => setBillingPeriod('annual')}
          >
            <Text style={[
              styles.toggleText,
              billingPeriod === 'annual' && styles.toggleTextActive
            ]}>
              Annual
            </Text>
            <View style={styles.savingsBadge}>
              <Text style={styles.savingsText}>Save 17%</Text>
            </View>
          </TouchableOpacity>
        </View>

        {/* Pricing Cards */}
        <ScrollView style={styles.plansContainer}>
          {/* Free Plan */}
          <View style={styles.planCard}>
            <View style={styles.planHeader}>
              <Text style={styles.planName}>Free</Text>
              <View style={styles.planPriceContainer}>
                <Text style={styles.planPrice}>$0</Text>
                <Text style={styles.planPeriod}>/forever</Text>
              </View>
            </View>
            <View style={styles.planFeatures}>
              {INDIVIDUAL_PRICING.free.features.map((feature, index) => (
                <View key={index} style={styles.featureRow}>
                  <Text style={styles.featureCheck}>‚úì</Text>
                  <Text style={styles.featureText}>{feature}</Text>
                </View>
              ))}
            </View>
            <TouchableOpacity
              style={styles.planButton}
              onPress={() => handleSelectPlan('free')}
            >
              <Text style={styles.planButtonText}>Get Started Free</Text>
            </TouchableOpacity>
          </View>

          {/* Basic Plan */}
          <View style={[styles.planCard, styles.planCardPopular]}>
            <View style={styles.popularBadge}>
              <Text style={styles.popularText}>MOST POPULAR</Text>
            </View>
            <View style={styles.planHeader}>
              <Text style={styles.planName}>Basic</Text>
              <View style={styles.planPriceContainer}>
                <Text style={styles.planPrice}>
                  ${billingPeriod === 'monthly' ? 
                    INDIVIDUAL_PRICING.basic.monthly : 
                    (INDIVIDUAL_PRICING.basic.annual / 12).toFixed(2)
                  }
                </Text>
                <Text style={styles.planPeriod}>/month</Text>
              </View>
              {billingPeriod === 'annual' && (
                <Text style={styles.billedAnnually}>
                  Billed ${INDIVIDUAL_PRICING.basic.annual}/year
                </Text>
              )}
            </View>
            <View style={styles.planFeatures}>
              {INDIVIDUAL_PRICING.basic.features.map((feature, index) => (
                <View key={index} style={styles.featureRow}>
                  <Text style={styles.featureCheck}>‚úì</Text>
                  <Text style={styles.featureText}>{feature}</Text>
                </View>
              ))}
            </View>
            <TouchableOpacity
              style={[styles.planButton, styles.planButtonPrimary]}
              onPress={() => handleSelectPlan('basic')}
            >
              <Text style={[styles.planButtonText, styles.planButtonTextPrimary]}>
                Select Basic
              </Text>
            </TouchableOpacity>
          </View>

          {/* Premium Plan */}
          <View style={styles.planCard}>
            <View style={styles.planHeader}>
              <Text style={styles.planName}>Premium</Text>
              <View style={styles.planPriceContainer}>
                <Text style={styles.planPrice}>
                  ${billingPeriod === 'monthly' ? 
                    INDIVIDUAL_PRICING.premium.monthly : 
                    (INDIVIDUAL_PRICING.premium.annual / 12).toFixed(2)
                  }
                </Text>
                <Text style={styles.planPeriod}>/month</Text>
              </View>
              {billingPeriod === 'annual' && (
                <Text style={styles.billedAnnually}>
                  Billed ${INDIVIDUAL_PRICING.premium.annual}/year
                </Text>
              )}
            </View>
            <View style={styles.planFeatures}>
              {INDIVIDUAL_PRICING.premium.features.map((feature, index) => (
                <View key={index} style={styles.featureRow}>
                  <Text style={styles.featureCheck}>‚úì</Text>
                  <Text style={styles.featureText}>{feature}</Text>
                </View>
              ))}
            </View>
            <TouchableOpacity
              style={styles.planButton}
              onPress={() => handleSelectPlan('premium')}
            >
              <Text style={styles.planButtonText}>Select Premium</Text>
            </TouchableOpacity>
          </View>
        </ScrollView>
      </View>
    );
  };

  return (
    <View style={styles.container}>
      <ScrollView style={styles.scrollView} contentContainerStyle={styles.scrollContent}>
        {/* Header */}
        <View style={styles.header}>
          <TouchableOpacity
            style={styles.backButton}
            onPress={() => onNavigate('register')}
          >
            <Text style={styles.backButtonText}>‚Üê Back</Text>
          </TouchableOpacity>
          <Text style={styles.headerTitle}>
            {userType === 'lawfirm' ? 'Law Firm Pricing' : 'Select Your Plan'}
          </Text>
        </View>

        {/* Content */}
        {userType === 'lawfirm' ? renderLawFirmPricing() : renderIndividualPricing()}

        {/* Footer */}
        <View style={styles.footer}>
          <Text style={styles.footerText}>
            ‚úì No setup fees  ‚úì Cancel anytime  ‚úì 14-day free trial
          </Tex