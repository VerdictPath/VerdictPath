-- CLIENT-MEDICAL PROVIDER RELATIONSHIP
-- Add this to your database schema to link clients with medical providers

-- Table to track which medical providers a client has visited
CREATE TABLE client_medical_providers (
  id SERIAL PRIMARY KEY,
  client_id INTEGER NOT NULL REFERENCES clients(id) ON DELETE CASCADE,
  medical_provider_id INTEGER NOT NULL REFERENCES medical_providers(id) ON DELETE CASCADE,
  
  -- Relationship details
  relationship_type VARCHAR(50) DEFAULT 'patient', -- patient, former_patient
  first_visit_date DATE,
  last_visit_date DATE,
  
  -- Status
  is_active BOOLEAN DEFAULT true,
  
  -- Timestamps
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  -- Ensure no duplicate relationships
  UNIQUE(client_id, medical_provider_id)
);

-- Indexes
CREATE INDEX idx_client_medical_providers_client ON client_medical_providers(client_id);
CREATE INDEX idx_client_medical_providers_provider ON client_medical_providers(medical_provider_id);

-- Update clients table to optionally track primary medical provider
ALTER TABLE clients 
ADD COLUMN primary_medical_provider_id INTEGER REFERENCES medical_providers(id);

-- API ENDPOINTS TO ADD:

// Backend route to link a client with a medical provider
// Add to routes/clients.js or create routes/client-relationships.js

router.post('/api/clients/:clientId/link-medical-provider', authenticateToken, async (req, res) => {
  try {
    const { clientId } = req.params;
    const { medicalProviderId, isPrimary } = req.body;
    
    // Verify authorization (law firm or medical provider can create link)
    const userType = getUserType(req.user);
    if (!['law_firm', 'medical_provider'].includes(userType)) {
      return res.status(403).json({ 
        success: false, 
        message: 'Unauthorized' 
      });
    }
    
    // Insert relationship
    await db.query(
      `INSERT INTO client_medical_providers (client_id, medical_provider_id)
       VALUES ($1, $2)
       ON CONFLICT (client_id, medical_provider_id) 
       DO UPDATE SET is_active = true, updated_at = CURRENT_TIMESTAMP`,
      [clientId, medicalProviderId]
    );
    
    // Update primary provider if specified
    if (isPrimary) {
      await db.query(
        'UPDATE clients SET primary_medical_provider_id = $1 WHERE id = $2',
        [medicalProviderId, clientId]
      );
    }
    
    res.json({
      success: true,
      message: 'Client linked to medical provider successfully'
    });
    
  } catch (error) {
    console.error('Error linking client to medical provider:', error);
    res.status(500).json({ 
      success: false, 
      message: 'Failed to link client to medical provider' 
    });
  }
});

// Get all medical providers for a specific client
router.get('/api/clients/:clientId/medical-providers', authenticateToken, async (req, res) => {
  try {
    const { clientId } = req.params;
    
    const result = await db.query(
      `SELECT 
        mp.*,
        cmp.relationship_type,
        cmp.first_visit_date,
        cmp.last_visit_date,
        cmp.is_active,
        (mp.id = c.primary_medical_provider_id) as is_primary
       FROM client_medical_providers cmp
       JOIN medical_providers mp ON cmp.medical_provider_id = mp.id
       JOIN clients c ON cmp.client_id = c.id
       WHERE cmp.client_id = $1 AND cmp.is_active = true
       ORDER BY is_primary DESC, mp.provider_name`,
      [clientId]
    );
    
    res.json({
      success: true,
      providers: result.rows
    });
    
  } catch (error) {
    console.error('Error fetching medical providers for client:', error);
    res.status(500).json({ 
      success: false, 
      message: 'Failed to fetch medical providers' 
    });
  }
});

// FRONTEND HELPER COMPONENT:
// Add this to help law firms select medical providers when initiating negotiations

import React, { useState, useEffect } from 'react';
import { View, Text, TouchableOpacity, StyleSheet, Alert } from 'react-native';
import { apiRequest, API_ENDPOINTS } from '../config/api';

const SelectMedicalProviderModal = ({ clientId, authToken, onSelect, onCancel }) => {
  const [providers, setProviders] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    loadProviders();
  }, [clientId]);

  const loadProviders = async () => {
    try {
      const response = await apiRequest(`/api/clients/${clientId}/medical-providers`, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${authToken}`
        }
      });
      
      setProviders(response.providers || []);
    } catch (error) {
      console.error('Error loading providers:', error);
      Alert.alert('Error', 'Failed to load medical providers');
    } finally {
      setLoading(false);
    }
  };

  if (loading) {
    return <Text>Loading providers...</Text>;
  }

  if (providers.length === 0) {
    return (
      <View style={styles.emptyState}>
        <Text style={styles.emptyText}>
          No medical providers linked to this client yet.
        </Text>
        <Text style={styles.emptySubtext}>
          Link a medical provider to this client before starting negotiations.
        </Text>
      </View>
    );
  }

  return (
    <View>
      <Text style={styles.title}>Select Medical Provider</Text>
      {providers.map(provider => (
        <TouchableOpacity
          key={provider.id}
          style={styles.providerCard}
          onPress={() => onSelect(provider.id)}
        >
          <Text style={styles.providerName}>{provider.provider_name}</Text>
          {provider.is_primary && (
            <View style={styles.primaryBadge}>
              <Text style={styles.primaryText}>Primary</Text>
            </View>
          )}
        </TouchableOpacity>
      ))}
      <TouchableOpacity style={styles.cancelButton} onPress={onCancel}>
        <Text style={styles.cancelText}>Cancel</Text>
      </TouchableOpacity>
    </View>
  );
};

const styles = StyleSheet.create({
  title: {
    fontSize: 18,
    fontWeight: 'bold',
    marginBottom: 15,
  },
  providerCard: {
    backgroundColor: '#fff',
    padding: 15,
    borderRadius: 8,
    marginBottom: 10,
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    borderWidth: 1,
    borderColor: '#ddd',
  },
  providerName: {
    fontSize: 16,
    fontWeight: '600',
  },
  primaryBadge: {
    backgroundColor: '#28a745',
    paddingHorizontal: 10,
    paddingVertical: 5,
    borderRadius: 5,
  },
  primaryText: {
    color: '#fff',
    fontSize: 12,
    fontWeight: '600',
  },
  emptyState: {
    padding: 20,
    alignItems: 'center',
  },
  emptyText: {
    fontSize: 16,
    fontWeight: '600',
    marginBottom: 10,
    textAlign: 'center',
  },
  emptySubtext: {
    fontSize: 14,
    color: '#666',
    textAlign: 'center',
  },
  cancelButton: {
    marginTop: 15,
    padding: 15,
    backgroundColor: '#f8f9fa',
    borderRadius: 8,
    alignItems: 'center',
  },
  cancelText: {
    fontSize: 16,
    color: '#666',
  },
});

export default SelectMedicalProviderModal;