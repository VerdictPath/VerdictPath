// STRIPE SUBSCRIPTION INTEGRATION
// Add this to your backend routes

const express = require('express');
const router = express.Router();
const stripe = require('stripe')(process.env.STRIPE_SECRET_KEY);
const { authenticateToken } = require('../middleware/auth');
const db = require('../config/database');

// ============================================================================
// SUBSCRIPTION CONFIGURATION
// ============================================================================

// Stripe Price IDs - Set these in your environment variables
// Create these in your Stripe Dashboard under Products
const PRICE_IDS = {
  individual: {
    free: null, // Free tier doesn't need Stripe
    basic: process.env.STRIPE_PRICE_INDIVIDUAL_BASIC, // e.g., price_xxx
    premium: process.env.STRIPE_PRICE_INDIVIDUAL_PREMIUM
  },
  lawfirm: {
    free: null,
    basic: process.env.STRIPE_PRICE_LAWFIRM_BASIC,
    premium: process.env.STRIPE_PRICE_LAWFIRM_PREMIUM
  },
  medical_provider: {
    free: null,
    basic: process.env.STRIPE_PRICE_PROVIDER_BASIC,
    premium: process.env.STRIPE_PRICE_PROVIDER_PREMIUM
  }
};

// ============================================================================
// CREATE CHECKOUT SESSION
// ============================================================================

router.post('/subscriptions/create-checkout-session', authenticateToken, async (req, res) => {
  try {
    const { tier, userType, successUrl, cancelUrl } = req.body;

    if (!tier || tier === 'free') {
      return res.status(400).json({
        success: false,
        message: 'Free tier does not require payment'
      });
    }

    // Get price ID based on user type and tier
    const priceId = PRICE_IDS[userType]?.[tier];

    if (!priceId) {
      return res.status(400).json({
        success: false,
        message: 'Invalid subscription tier or user type'
      });
    }

    // Get or create Stripe customer
    let customerId;
    
    if (userType === 'individual') {
      const client = await db.query(
        'SELECT stripe_customer_id FROM clients WHERE id = $1',
        [req.user.id]
      );
      customerId = client.rows[0]?.stripe_customer_id;
    } else if (userType === 'lawfirm') {
      const firm = await db.query(
        'SELECT stripe_customer_id FROM law_firms WHERE id = $1',
        [req.user.id]
      );
      customerId = firm.rows[0]?.stripe_customer_id;
    } else if (userType === 'medical_provider') {
      const provider = await db.query(
        'SELECT stripe_customer_id FROM medical_providers WHERE id = $1',
        [req.user.id]
      );
      customerId = provider.rows[0]?.stripe_customer_id;
    }

    // Create Stripe customer if doesn't exist
    if (!customerId) {
      const customer = await stripe.customers.create({
        email: req.user.email,
        metadata: {
          userId: req.user.id,
          userType: userType
        }
      });
      customerId = customer.id;

      // Save customer ID
      if (userType === 'individual') {
        await db.query(
          'UPDATE clients SET stripe_customer_id = $1 WHERE id = $2',
          [customerId, req.user.id]
        );
      } else if (userType === 'lawfirm') {
        await db.query(
          'UPDATE law_firms SET stripe_customer_id = $1 WHERE id = $2',
          [customerId, req.user.id]
        );
      } else if (userType === 'medical_provider') {
        await db.query(
          'UPDATE medical_providers SET stripe_customer_id = $1 WHERE id = $2',
          [customerId, req.user.id]
        );
      }
    }

    // Create checkout session
    const session = await stripe.checkout.sessions.create({
      customer: customerId,
      mode: 'subscription',
      payment_method_types: ['card'],
      line_items: [
        {
          price: priceId,
          quantity: 1,
        },
      ],
      success_url: successUrl || `${process.env.FRONTEND_URL}/subscription-success?session_id={CHECKOUT_SESSION_ID}`,
      cancel_url: cancelUrl || `${process.env.FRONTEND_URL}/subscription-cancelled`,
      metadata: {
        userId: req.user.id,
        userType: userType,
        tier: tier
      }
    });

    res.json({
      success: true,
      sessionId: session.id,
      url: session.url
    });

  } catch (error) {
    console.error('Create checkout session error:', error);
    res.status(500).json({
      success: false,
      message: 'Failed to create checkout session'
    });
  }
});

// ============================================================================
// CREATE PORTAL SESSION (for managing subscription)
// ============================================================================

router.post('/subscriptions/portal-session', authenticateToken, async (req, res) => {
  try {
    const { userType, returnUrl } = req.body;

    // Get Stripe customer ID
    let customerId;
    
    if (userType === 'individual') {
      const client = await db.query(
        'SELECT stripe_customer_id FROM clients WHERE id = $1',
        [req.user.id]
      );
      customerId = client.rows[0]?.stripe_customer_id;
    } else if (userType === 'lawfirm') {
      const firm = await db.query(
        'SELECT stripe_customer_id FROM law_firms WHERE id = $1',
        [req.user.id]
      );
      customerId = firm.rows[0]?.stripe_customer_id;
    } else if (userType === 'medical_provider') {
      const provider = await db.query(
        'SELECT stripe_customer_id FROM medical_providers WHERE id = $1',
        [req.user.id]
      );
      customerId = provider.rows[0]?.stripe_customer_id;
    }

    if (!customerId) {
      return res.status(400).json({
        success: false,
        message: 'No active subscription found'
      });
    }

    // Create portal session
    const session = await stripe.billingPortal.sessions.create({
      customer: customerId,
      return_url: returnUrl || `${process.env.FRONTEND_URL}/dashboard`,
    });

    res.json({
      success: true,
      url: session.url
    });

  } catch (error) {
    console.error('Create portal session error:', error);
    res.status(500).json({
      success: false,
      message: 'Failed to create portal session'
    });
  }
});

// ============================================================================
// WEBHOOK HANDLER (CRITICAL!)
// ============================================================================

// This endpoint should NOT use authenticateToken middleware
router.post('/subscriptions/webhook', express.raw({ type: 'application/json' }), async (req, res) => {
  const sig = req.headers['stripe-signature'];
  let event;

  try {
    event = stripe.webhooks.constructEvent(
      req.body,
      sig,
      process.env.STRIPE_WEBHOOK_SECRET
    );
  } catch (err) {
    console.error('Webhook signature verification failed:', err.message);
    return res.status(400).send(`Webhook Error: ${err.message}`);
  }

  // Handle the event
  try {
    switch (event.type) {
      case 'checkout.session.completed':
        await handleCheckoutCompleted(event.data.object);
        break;

      case 'customer.subscription.created':
        await handleSubscriptionCreated(event.data.object);
        break;

      case 'customer.subscription.updated':
        await handleSubscriptionUpdated(event.data.object);
        break;

      case 'customer.subscription.deleted':
        await handleSubscriptionDeleted(event.data.object);
        break;

      case 'invoice.payment_succeeded':
        await handlePaymentSucceeded(event.data.object);
        break;

      case 'invoice.payment_failed':
        await handlePaymentFailed(event.data.object);
        break;

      default:
        console.log(`Unhandled event type: ${event.type}`);
    }

    res.json({ received: true });

  } catch (error) {
    console.error('Webhook handler error:', error);
    res.status(500).json({ error: 'Webhook handler failed' });
  }
});

// ============================================================================
// WEBHOOK EVENT HANDLERS
// ============================================================================

async function handleCheckoutCompleted(session) {
  console.log('Checkout completed:', session.id);
  
  const userId = session.metadata.userId;
  const userType = session.metadata.userType;
  const tier = session.metadata.tier;

  // Update user's subscription tier
  if (userType === 'individual') {
    await db.query(
      'UPDATE clients SET subscription_tier = $1, stripe_subscription_id = $2 WHERE id = $3',
      [tier, session.subscription, userId]
    );
  } else if (userType === 'lawfirm') {
    await db.query(
      'UPDATE law_firms SET subscription_tier = $1, stripe_subscription_id = $2 WHERE id = $3',
      [tier, session.subscription, userId]
    );
  } else if (userType === 'medical_provider') {
    await db.query(
      'UPDATE medical_providers SET subscription_tier = $1, stripe_subscription_id = $2 WHERE id = $3',
      [tier, session.subscription, userId]
    );
  }

  console.log(`User ${userId} (${userType}) upgraded to ${tier}`);
}

async function handleSubscriptionCreated(subscription) {
  console.log('Subscription created:', subscription.id);
  // Additional logic if needed
}

async function handleSubscriptionUpdated(subscription) {
  console.log('Subscription updated:', subscription.id);
  
  // Get user from customer ID
  const customer = await stripe.customers.retrieve(subscription.customer);
  const userId = customer.metadata.userId;
  const userType = customer.metadata.userType;

  // Determine tier from price ID
  let newTier = 'free';
  if (subscription.items.data.length > 0) {
    const priceId = subscription.items.data[0].price.id;
    
    // Find tier by matching price ID
    for (const [tier, id] of Object.entries(PRICE_IDS[userType] || {})) {
      if (id === priceId) {
        newTier = tier;
        break;
      }
    }
  }

  // Check subscription status
  if (subscription.status === 'active') {
    // Update user's tier
    if (userType === 'individual') {
      await db.query(
        'UPDATE clients SET subscription_tier = $1 WHERE id = $2',
        [newTier, userId]
      );
    } else if (userType === 'lawfirm') {
      await db.query(
        'UPDATE law_firms SET subscription_tier = $1 WHERE id = $2',
        [newTier, userId]
      );
    } else if (userType === 'medical_provider') {
      await db.query(
        'UPDATE medical_providers SET subscription_tier = $1 WHERE id = $2',
        [newTier, userId]
      );
    }
  } else if (subscription.status === 'canceled' || subscription.status === 'unpaid') {
    // Downgrade to free
    if (userType === 'individual') {
      await db.query(
        'UPDATE clients SET subscription_tier = $1 WHERE id = $2',
        ['free', userId]
      );
    } else if (userType === 'lawfirm') {
      await db.query(
        'UPDATE law_firms SET subscription_tier = $1 WHERE id = $2',
        ['free', userId]
      );
    } else if (userType === 'medical_provider') {
      await db.query(
        'UPDATE medical_providers SET subscription_tier = $1 WHERE id = $2',
        ['free', userId]
      );
    }
  }
}

async function handleSubscriptionDeleted(subscription) {
  console.log('Subscription deleted:', subscription.id);
  
  // Get user from customer ID
  const customer = await stripe.customers.retrieve(subscription.customer);
  const userId = customer.metadata.userId;
  const userType = customer.metadata.userType;

  // Downgrade to free tier
  if (userType === 'individual') {
    await db.query(
      'UPDATE clients SET subscription_tier = $1, stripe_subscription_id = NULL WHERE id = $2',
      ['free', userId]
    );
  } else if (userType === 'lawfirm') {
    await db.query(
      'UPDATE law_firms SET subscription_tier = $1, stripe_subscription_id = NULL WHERE id = $2',
      ['free', userId]
    );
  } else if (userType === 'medical_provider') {
    await db.query(
      'UPDATE medical_providers SET subscription_tier = $1, stripe_subscription_id = NULL WHERE id = $2',
      ['free', userId]
    );
  }

  console.log(`User ${userId} (${userType}) downgraded to free tier`);
}

async function handlePaymentSucceeded(invoice) {
  console.log('Payment succeeded:', invoice.id);
  
  // Log successful payment
  const customer = await stripe.customers.retrieve(invoice.customer);
  const userId = customer.metadata.userId;
  const userType = customer.metadata.userType;

  // You could send a notification here
  console.log(`Payment of $${invoice.amount_paid / 100} succeeded for user ${userId}`);
}

async function handlePaymentFailed(invoice) {
  console.log('Payment failed:', invoice.id);
  
  // Get user info
  const customer = await stripe.customers.retrieve(invoice.customer);
  const userId = customer.metadata.userId;
  const userType = customer.metadata.userType;

  // Send notification to user about failed payment
  await db.query(
    `INSERT INTO notifications (user_id, user_type, title, body, notification_type, created_at)
     VALUES ($1, $2, $3, $4, $5, NOW())`,
    [
      userId,
      userType,
      'Payment Failed',
      'Your subscription payment failed. Please update your payment method to avoid service interruption.',
      'payment_failed'
    ]
  );

  console.log(`Payment failed for user ${userId} (${userType})`);
}

// ============================================================================
// GET CURRENT SUBSCRIPTION STATUS
// ============================================================================

router.get('/subscriptions/status', authenticateToken, async (req, res) => {
  try {
    const { userType } = req.query;

    let subscriptionData;

    if (userType === 'individual') {
      const result = await db.query(
        'SELECT subscription_tier, stripe_customer_id, stripe_subscription_id FROM clients WHERE id = $1',
        [req.user.id]
      );
      subscriptionData = result.rows[0];
    } else if (userType === 'lawfirm') {
      const result = await db.query(
        'SELECT subscription_tier, stripe_customer_id, stripe_subscription_id FROM law_firms WHERE id = $1',
        [req.user.id]
      );
      subscriptionData = result.rows[0];
    } else if (userType === 'medical_provider') {
      const result = await db.query(
        'SELECT subscription_tier, stripe_customer_id, stripe_subscription_id FROM medical_providers WHERE id = $1',
        [req.user.id]
      );
      subscriptionData = result.rows[0];
    }

    if (!subscriptionData) {
      return res.status(404).json({
        success: false,
        message: 'User not found'
      });
    }

    // If they have a Stripe subscription, get details from Stripe
    let stripeSubscription = null;
    if (subscriptionData.stripe_subscription_id) {
      try {
        stripeSubscription = await stripe.subscriptions.retrieve(
          subscriptionData.stripe_subscription_id
        );
      } catch (error) {
        console.error('Error retrieving Stripe subscription:', error);
      }
    }

    res.json({
      success: true,
      tier: subscriptionData.subscription_tier,
      hasStripeSubscription: !!subscriptionData.stripe_subscription_id,
      stripeStatus: stripeSubscription?.status,
      currentPeriodEnd: stripeSubscription?.current_period_end,
      cancelAtPeriodEnd: stripeSubscription?.cancel_at_period_end
    });

  } catch (error) {
    console.error('Get subscription status error:', error);
    res.status(500).json({
      success: false,
      message: 'Failed to get subscription status'
    });
  }
});

module.exports = router;