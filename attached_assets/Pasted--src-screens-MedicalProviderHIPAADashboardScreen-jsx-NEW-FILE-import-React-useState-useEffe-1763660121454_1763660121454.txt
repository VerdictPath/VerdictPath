// src/screens/MedicalProviderHIPAADashboardScreen.jsx - NEW FILE

import React, { useState, useEffect } from 'react';
import {
  View,
  Text,
  ScrollView,
  StyleSheet,
  TouchableOpacity,
  RefreshControl,
} from 'react-native';
import { LinearGradient } from 'expo-linear-gradient';
import { BlurView } from 'expo-blur';
import MedicalGlassCard from '../components/MedicalGlassCard';
import MedicalStatCard from '../components/MedicalStatCard';
import { medicalProviderTheme } from '../styles/medicalProviderTheme';
import { apiRequest } from '../config/api';

const MedicalProviderHIPAADashboardScreen = ({ user, onBack }) => {
  const [report, setReport] = useState(null);
  const [loading, setLoading] = useState(true);
  const [refreshing, setRefreshing] = useState(false);
  const [timeFilter, setTimeFilter] = useState('month');

  useEffect(() => {
    loadHIPAAReport();
  }, [timeFilter]);

  const loadHIPAAReport = async () => {
    try {
      setLoading(true);
      
      const dateFilters = getDateFilters(timeFilter);
      const queryString = new URLSearchParams(dateFilters).toString();
      
      const response = await apiRequest(
        `/api/medicalprovider/activity/hipaa-report?${queryString}`,
        {
          method: 'GET',
          headers: { 'Authorization': `Bearer ${user.token}` },
        }
      );

      setReport(response.hipaaReport);
    } catch (error) {
      console.error('[HIPAADashboard] Load error:', error);
    } finally {
      setLoading(false);
      setRefreshing(false);
    }
  };

  const getDateFilters = (filter) => {
    const now = new Date();
    const filters = {};

    switch (filter) {
      case 'week':
        filters.startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000).toISOString();
        break;
      case 'month':
        filters.startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000).toISOString();
        break;
      case 'quarter':
        filters.startDate = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000).toISOString();
        break;
      case 'year':
        filters.startDate = new Date(now.getTime() - 365 * 24 * 60 * 60 * 1000).toISOString();
        break;
    }

    return filters;
  };

  const onRefresh = () => {
    setRefreshing(true);
    loadHIPAAReport();
  };

  if (loading || !report) {
    return (
      <View style={styles.container}>
        <LinearGradient
          colors={[
            medicalProviderTheme.colors.clinicalWhite,
            medicalProviderTheme.colors.lightGray,
          ]}
          style={styles.background}
        />
        <Text style={styles.loadingText}>Generating HIPAA compliance report...</Text>
      </View>
    );
  }

  return (
    <View style={styles.container}>
      <LinearGradient
        colors={[
          medicalProviderTheme.colors.clinicalWhite,
          medicalProviderTheme.colors.lightGray,
        ]}
        style={styles.background}
      />

      {/* Header */}
      <LinearGradient
        colors={[
          medicalProviderTheme.colors.deepTeal,
          medicalProviderTheme.colors.clinicalTeal,
        ]}
        style={styles.headerGradient}
      >
        <BlurView intensity={10} style={styles.header}>
          <View style={styles.headerContent}>
            <TouchableOpacity onPress={onBack}>
              <Text style={styles.backText}>‚Üê Back</Text>
            </TouchableOpacity>
            <View style={styles.headerTitleContainer}>
              <Text style={styles.headerIcon}>üîí</Text>
              <Text style={styles.headerTitle}>HIPAA Compliance</Text>
            </View>
            <View style={{ width: 60 }} />
          </View>
        </BlurView>
      </LinearGradient>

      {/* Time Filter */}
      <View style={styles.filterContainer}>
        <ScrollView horizontal showsHorizontalScrollIndicator={false}>
          {['week', 'month', 'quarter', 'year'].map((filter) => (
            <TouchableOpacity
              key={filter}
              style={[
                styles.filterChip,
                timeFilter === filter && styles.filterChipActive,
              ]}
              onPress={() => setTimeFilter(filter)}
            >
              <Text
                style={[
                  styles.filterChipText,
                  timeFilter === filter && styles.filterChipTextActive,
                ]}
              >
                {filter === 'week' ? 'Last Week' : 
                 filter === 'month' ? 'Last Month' :
                 filter === 'quarter' ? 'Last Quarter' : 'Last Year'}
              </Text>
            </TouchableOpacity>
          ))}
        </ScrollView>
      </View>

      <ScrollView
        style={styles.scrollView}
        contentContainerStyle={styles.content}
        refreshControl={
          <RefreshControl
            refreshing={refreshing}
            onRefresh={onRefresh}
            tintColor={medicalProviderTheme.colors.accentTeal}
          />
        }
      >
        {/* Report Header */}
        <MedicalGlassCard variant="mint" style={styles.reportHeaderCard}>
          <View style={styles.reportHeader}>
            <Text style={styles.reportTitle}>HIPAA Audit Report</Text>
            <Text style={styles.reportDate}>
              Generated: {new Date(report.reportGeneratedAt).toLocaleString()}
            </Text>
          </View>
        </MedicalGlassCard>

        {/* Key Metrics */}
        <Text style={styles.sectionTitle}>Key Compliance Metrics</Text>
        <View style={styles.statsRow}>
          <MedicalStatCard
            label="PHI Access Events"
            value={report.totalPHIAccess}
            icon="üîê"
            color={medicalProviderTheme.colors.accentTeal}
            size="small"
            status="stable"
          />
          <View style={{ width: 12 }} />
          <MedicalStatCard
            label="Failed Access"
            value={report.failedAccessAttempts}
            icon="üö´"
            color={medicalProviderTheme.colors.emergencyRed}
            size="small"
            status={report.failedAccessAttempts > 0 ? 'critical' : 'healthy'}
          />
          <View style={{ width: 12 }} />
          <MedicalStatCard
            label="Audit Required"
            value={report.criticalActionsRequiringAudit}
            icon="‚ö†Ô∏è"
            color={medicalProviderTheme.colors.warning}
            size="small"
            status={report.criticalActionsRequiringAudit > 0 ? 'warning' : 'healthy'}
          />
        </View>

        {/* Risk Assessment */}
        <Text style={styles.sectionTitle}>Risk Assessment</Text>
        <View style={styles.sensitivityGrid}>
          {report.sensitivityBreakdown.map((item) => (
            <RiskLevelCard
              key={item._id}
              level={item._id}
              count={item.count}
            />
          ))}
        </View>

        {/* Failed Access Attempts */}
        {report.failedAccessDetails && report.failedAccessDetails.length > 0 && (
          <>
            <View style={styles.sectionHeader}>
              <Text style={styles.sectionTitle}>Failed Access Attempts</Text>
              <View style={styles.criticalBadge}>
                <Text style={styles.criticalBadgeText}>‚ö†Ô∏è CRITICAL</Text>
              </View>
            </View>
            <MedicalGlassCard variant="white" style={styles.warningCard}>
              <Text style={styles.warningText}>
                {report.failedAccessDetails.length} failed access attempt(s) detected. 
                These require immediate investigation for potential security breaches.
              </Text>
            </MedicalGlassCard>

            {report.failedAccessDetails.slice(0, 5).map((attempt, index) => (
              <FailedAccessCard key={attempt._id || index} attempt={attempt} />
            ))}
          </>
        )}

        {/* User Access Patterns */}
        <Text style={styles.sectionTitle}>User Access Patterns</Text>
        <Text style={styles.sectionDescription}>
          Staff members sorted by high-sensitivity activities
        </Text>
        {report.userAccessPatterns
          .filter(pattern => ['high', 'critical'].includes(pattern._id.sensitivityLevel))
          .slice(0, 10)
          .map((pattern, index) => (
            <UserAccessPatternCard
              key={`${pattern._id.userId}-${index}`}
              pattern={pattern}
            />
          ))}

        {/* Compliance Checklist */}
        <Text style={styles.sectionTitle}>Compliance Checklist</Text>
        <MedicalGlassCard variant="white" style={styles.checklistCard}>
          <ChecklistItem
            label="Activity Logging Enabled"
            status="passed"
            description="All PHI access is being logged"
          />
          <ChecklistItem
            label="Data Retention Policy"
            status="passed"
            description="7-year retention configured"
          />
          <ChecklistItem
            label="Failed Access Monitoring"
            status={report.failedAccessAttempts === 0 ? 'passed' : 'attention'}
            description={
              report.failedAccessAttempts === 0
                ? 'No failed access attempts'
                : `${report.failedAccessAttempts} failed attempts detected`
            }
          />
          <ChecklistItem
            label="Critical Action Auditing"
            status={report.criticalActionsRequiringAudit > 0 ? 'review' : 'passed'}
            description={
              report.criticalActionsRequiringAudit > 0
                ? `${report.criticalActionsRequiringAudit} actions require review`
                : 'No pending audits'
            }
          />
          <ChecklistItem
            label="User Authentication"
            status="passed"
            description="Multi-factor authentication available"
          />
        </MedicalGlassCard>

        {/* Export Options */}
        <Text style={styles.sectionTitle}>Report Actions</Text>
        <View style={styles.actionsGrid}>
          <TouchableOpacity style={styles.actionCard}>
            <Text style={styles.actionIcon}>üìÑ</Text>
            <Text style={styles.actionLabel}>Export PDF</Text>
          </TouchableOpacity>
          <TouchableOpacity style={styles.actionCard}>
            <Text style={styles.actionIcon}>üìä</Text>
            <Text style={styles.actionLabel}>Export CSV</Text>
          </TouchableOpacity>
          <TouchableOpacity style={styles.actionCard}>
            <Text style={styles.actionIcon}>üìß</Text>
            <Text style={styles.actionLabel}>Email Report</Text>
          </TouchableOpacity>
          <TouchableOpacity style={styles.actionCard}>
            <Text style={styles.actionIcon}>üìÅ</Text>
            <Text style={styles.actionLabel}>Archive</Text>
          </TouchableOpacity>
        </View>

        {/* Disclaimer */}
        <MedicalGlassCard variant="mint" style={styles.disclaimerCard}>
          <Text style={styles.disclaimerTitle}>üìã HIPAA Compliance Notice</Text>
          <Text style={styles.disclaimerText}>
            This report provides an overview of Protected Health Information (PHI) access 
            activities. Regular review of these reports is required under HIPAA regulations. 
            All critical actions and failed access attempts must be investigated and documented. 
            Retain this report for at least 7 years as required by HIPAA.
          </Text>
        </MedicalGlassCard>

        <View style={{ height: 100 }} />
      </ScrollView>
    </View>
  );
};

const RiskLevelCard = ({ level, count }) => {
  const riskData = {
    low: {
      label: 'Low Risk',
      icon: '‚úì',
      color: medicalProviderTheme.colors.healthy,
      description: 'Routine activities',
    },
    medium: {
      label: 'Medium Risk',
      icon: '‚óê',
      color: medicalProviderTheme.colors.stable,
      description: 'Standard medical access',
    },
    high: {
      label: 'High Risk',
      icon: '‚ö†',
      color: medicalProviderTheme.colors.warning,
      description: 'Sensitive data access',
    },
    critical: {
      label: 'Critical',
      icon: '‚ö†Ô∏è',
      color: medicalProviderTheme.colors.critical,
      description: 'Requires audit',
    },
  };

  const risk = riskData[level] || riskData.medium;

  return (
    <MedicalGlassCard variant="white" style={styles.riskCard}>
      <View style={[styles.riskIconBg, { backgroundColor: risk.color + '30' }]}>
        <Text style={styles.riskIcon}>{risk.icon}</Text>
      </View>
      <Text style={[styles.riskCount, { color: risk.color }]}>{count}</Text>
      <Text style={styles.riskLabel}>{risk.label}</Text>
      <Text style={styles.riskDescription}>{risk.description}</Text>
    </MedicalGlassCard>
  );
};

const FailedAccessCard = ({ attempt }) => {
  return (
    <MedicalGlassCard variant="white" style={styles.failedAccessCard}>
      <View style={styles.failedAccessHeader}>
        <View style={styles.failedAccessIcon}>
          <Text style={styles.failedAccessIconText}>üö´</Text>
        </View>
        <View style={styles.failedAccessInfo}>
          <Text style={styles.failedAccessUser}>
            {attempt.userName || attempt.userEmail}
          </Text>
          <Text style={styles.failedAccessAction}>
            {attempt.action.replace(/_/g, ' ')}
          </Text>
          <Text style={styles.failedAccessTime}>
            {new Date(attempt.timestamp).toLocaleString()}
          </Text>
        </View>
        <View style={styles.failedAccessBadge}>
          <Text style={styles.failedAccessBadgeText}>FAILED</Text>
        </View>
      </View>
      {attempt.errorMessage && (
        <Text style={styles.failedAccessError}>
          Error: {attempt.errorMessage}
        </Text>
      )}
    </MedicalGlassCard>
  );
};

const UserAccessPatternCard = ({ pattern }) => {
  const getSensitivityColor = (level) => {
    const colors = {
      low: medicalProviderTheme.colors.healthy,
      medium: medicalProviderTheme.colors.stable,
      high: medicalProviderTheme.colors.warning,
      critical: medicalProviderTheme.colors.critical,
    };
    return colors[level] || colors.medium;
  };

  return (
    <MedicalGlassCard variant="white" style={styles.patternCard}>
      <View style={styles.patternContent}>
        <View style={styles.patternInfo}>
          <Text style={styles.patternUserName}>{pattern.userName}</Text>
          <Text style={styles.patternUserRole}>
            {pattern.userRole?.replace(/_/g, ' ')}
          </Text>
        </View>
        <View style={styles.patternStats}>
          <View
            style={[
              styles.patternSensitivityBadge,
              {
                backgroundColor:
                  getSensitivityColor(pattern._id.sensitivityLevel) + '30',
              },
            ]}
          >
            <Text
              style={[
                styles.patternSensitivityText,
                { color: getSensitivityColor(pattern._id.sensitivityLevel) },
              ]}
            >
              {pattern._id.sensitivityLevel.toUpperCase()}
            </Text>
          </View>
          <Text style={styles.patternCount}>{pattern.count} actions</Text>
        </View>
      </View>
    </MedicalGlassCard>
  );
};

const ChecklistItem = ({ label, status, description }) => {
  const statusConfig = {
    passed: {
      icon: '‚úÖ',
      color: medicalProviderTheme.colors.healthy,
      text: 'Passed',
    },
    attention: {
      icon: '‚ö†Ô∏è',
      color: medicalProviderTheme.colors.warning,
      text: 'Attention',
    },
    review: {
      icon: 'üîç',
      color: medicalProviderTheme.colors.warning,
      text: 'Review',
    },
    failed: {
      icon: '‚ùå',
      color: medicalProviderTheme.colors.critical,
      text: 'Failed',
    },
  };

  const config = statusConfig[status] || statusConfig.passed;

  return (
    <View style={styles.checklistItem}>
      <Text style={styles.checklistIcon}>{config.icon}</Text>
      <View style={styles.checklistInfo}>
        <Text style={styles.checklistLabel}>{label}</Text>
        <Text style={styles.checklistDescription}>{description}</Text>
      </View>
      <View style={[styles.checklistStatus, { backgroundColor: config.color + '30' }]}>
        <Text style={[styles.checklistStatusText, { color: config.color }]}>
          {config.text}
        </Text>
      </View>
    </View>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: medicalProviderTheme.colors.clinicalWhite,
  },
  background: {
    position: 'absolute',
    left: 0,
    right: 0,
    top: 0,
    bottom: 0,
  },
  headerGradient: {
    paddingTop: 60,
  },
  header: {
    paddingHorizontal: 20,
    paddingBottom: 20,
  },
  headerContent: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
  },
  backText: {
    color: '#FFFFFF',
    fontSize: 16,
    fontWeight: '600',
  },
  headerTitleContainer: {
    flexDirection: 'row',
    alignItems: 'center',
  },
  headerIcon: {
    fontSize: 24,
    marginRight: 8,
  },
  headerTitle: {
    fontSize: 20,
    fontWeight: '700',
    color: '#FFFFFF',
  },
  filterContainer: {
    paddingHorizontal: 20,
    paddingVertical: 15,
  },
  filterChip: {
    paddingHorizontal: 20,
    paddingVertical: 10,
    borderRadius: 20,
    backgroundColor: medicalProviderTheme.colors.lightGray,
    marginRight: 10,
    borderWidth: 1,
    borderColor: medicalProviderTheme.colors.accentTeal + '30',
  },
  filterChipActive: {
    backgroundColor: medicalProviderTheme.colors.accentTeal,
    borderColor: medicalProviderTheme.colors.accentTeal,
  },
  filterChipText: {
    color: medicalProviderTheme.colors.deepTeal,
    fontSize: 14,
    fontWeight: '600',
  },
  filterChipTextActive: {
    color: '#FFFFFF',
  },
  scrollView: {
    flex: 1,
  },
  content: {
    padding: 20,
  },
  reportHeaderCard: {
    padding: 25,
    marginBottom: 25,
  },
  reportHeader: {
    alignItems: 'center',
  },
  reportTitle: {
    fontSize: 24,
    fontWeight: '700',
    color: medicalProviderTheme.colors.deepTeal,
    marginBottom: 8,
  },
  reportDate: {
    fontSize: 13,
    color: medicalProviderTheme.colors.mediumGray,
    fontStyle: 'italic',
  },
  sectionTitle: {
    fontSize: 20,
    fontWeight: '700',
    color: medicalProviderTheme.colors.deepTeal,
    marginBottom: 15,
  },
  sectionDescription: {
    fontSize: 14,
    color: medicalProviderTheme.colors.mediumGray,
    marginBottom: 15,
    marginTop: -10,
  },
  sectionHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: 15,
  },
  criticalBadge: {
    backgroundColor: medicalProviderTheme.colors.emergencyRed + '30',
    paddingHorizontal: 12,
    paddingVertical: 6,
    borderRadius: 12,
  },
  criticalBadgeText: {
    color: medicalProviderTheme.colors.emergencyRed,
    fontSize: 11,
    fontWeight: '700',
  },
  statsRow: {
    flexDirection: 'row',
    marginBottom: 30,
  },
  sensitivityGrid: {
    flexDirection: 'row',
    flexWrap: 'wrap',
    justifyContent: 'space-between',
    marginBottom: 30,
  },
  riskCard: {
    width: '48%',
    padding: 18,
    marginBottom: 15,
    alignItems: 'center',
  },
  riskIconBg: {
    width: 50,
    height: 50,
    borderRadius: 25,
    justifyContent: 'center',
    alignItems: 'center',
    marginBottom: 10,
  },
  riskIcon: {
    fontSize: 24,
  },
  riskCount: {
    fontSize: 28,
    fontWeight: '700',
    marginBottom: 4,
  },
  riskLabel: {
    fontSize: 14,
    fontWeight: '700',
    color: medicalProviderTheme.colors.deepTeal,
    marginBottom: 4,
  },
  riskDescription: {
    fontSize: 11,
    color: medicalProviderTheme.colors.mediumGray,
    textAlign: 'center',
  },
  warningCard: {
    padding: 20,
    marginBottom: 15,
    borderLeftWidth: 4,
    borderLeftColor: medicalProviderTheme.colors.emergencyRed,
  },
  warningText: {
    color: medicalProviderTheme.colors.deepTeal,
    fontSize: 14,
    lineHeight: 20,
  },
  failedAccessCard: {
    padding: 16,
    marginBottom: 12,
    borderLeftWidth: 3,
    borderLeftColor: medicalProviderTheme.colors.emergencyRed,
  },
  failedAccessHeader: {
    flexDirection: 'row',
    alignItems: 'center',
  },
  failedAccessIcon: {
    width: 40,
    height: 40,
    borderRadius: 20,
    backgroundColor: medicalProviderTheme.colors.emergencyRed + '20',
    justifyContent: 'center',
    alignItems: 'center',
    marginRight: 12,
  },
  failedAccessIconText: {
    fontSize: 20,
  },
  failedAccessInfo: {
    flex: 1,
  },
  failedAccessUser: {
    fontSize: 16,
    fontWeight: '700',
    color: medicalProviderTheme.colors.deepTeal,
    marginBottom: 2,
  },
  failedAccessAction: {
    fontSize: 13,
    color: medicalProviderTheme.colors.darkGray,
    textTransform: 'capitalize',
    marginBottom: 2,
  },
  failedAccessTime: {
    fontSize: 11,
    color: medicalProviderTheme.colors.mediumGray,
  },
  failedAccessBadge: {
    backgroundColor: medicalProviderTheme.colors.emergencyRed + '30',
    paddingHorizontal: 10,
    paddingVertical: 6,
    borderRadius: 8,
  },
  failedAccessBadgeText: {
    color: medicalProviderTheme.colors.emergencyRed,
    fontSize: 11,
    fontWeight: '700',
  },
  failedAccessError: {
    marginTop: 10,
    fontSize: 12,
    color: medicalProviderTheme.colors.emergencyRed,
    fontStyle: 'italic',
  },
  patternCard: {
    padding: 14,
    marginBottom: 10,
  },
  patternContent: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
  },
  patternInfo: {
    flex: 1,
  },
  patternUserName: {
    fontSize: 16,
    fontWeight: '700',
    color: medicalProviderTheme.colors.deepTeal,
    marginBottom: 4,
  },
  patternUserRole: {
    fontSize: 13,
    color: medicalProviderTheme.colors.mediumGray,
    textTransform: 'capitalize',
  },
  patternStats: {
    alignItems: 'flex-end',
  },
  patternSensitivityBadge: {
    paddingHorizontal: 10,
    paddingVertical: 4,
    borderRadius: 8,
    marginBottom: 6,
  },
  patternSensitivityText: {
    fontSize: 10,
    fontWeight: '700',
  },
  patternCount: {
    fontSize: 12,
    color: medicalProviderTheme.colors.mediumGray,
    fontWeight: '600',
  },
  checklistCard: {
    padding: 20,
    marginBottom: 25,
  },
  checklistItem: {
    flexDirection: 'row',
    alignItems: 'center',
    paddingVertical: 15,
    borderBottomWidth: 1,
    borderBottomColor: medicalProviderTheme.colors.lightGray,
  },
  checklistIcon: {
    fontSize: 24,
    marginRight: 15,
  },
  checklistInfo: {
    flex: 1,
  },
  checklistLabel: {
    fontSize: 15,
    fontWeight: '700',
    color: medicalProviderTheme.colors.deepTeal,
    marginBottom: 4,
  },
  checklistDescription: {
    fontSize: 12,
    color: medicalProviderTheme.colors.mediumGray,
  },
  checklistStatus: {
    paddingHorizontal: 10,
    paddingVertical: 6,
    borderRadius: 8,
  },
  checklistStatusText: {
    fontSize: 11,
    fontWeight: '700',
  },
  actionsGrid: {
    flexDirection: 'row',
    flexWrap: 'wrap',
    justifyContent: 'space-between',
    marginBottom: 25,
  },
  actionCard: {
    width: '48%',
    backgroundColor: medicalProviderTheme.colors.lightGray,
    padding: 20,
    borderRadius: 16,
    alignItems: 'center',
    marginBottom: 15,
    borderWidth: 1,
    borderColor: medicalProviderTheme.colors.accentTeal + '30',
  },
  actionIcon: {
    fontSize: 32,
    marginBottom: 8,
  },
  actionLabel: {
    fontSize: 14,
    fontWeight: '600',
    color: medicalProviderTheme.colors.deepTeal,
  },
  disclaimerCard: {
    padding: 20,
  },
  disclaimerTitle: {
    fontSize: 16,
    fontWeight: '700',
    color: medicalProviderTheme.colors.deepTeal,
    marginBottom: 12,
  },
  disclaimerText: {
    fontSize: 13,
    color: medicalProviderTheme.colors.darkGray,
    lineHeight: 20,
  },
  loadingText: {
    color: medicalProviderTheme.colors.accentTeal,
    fontSize: 18,
    textAlign: 'center',
    marginTop: 100,
  },
});

export default MedicalProviderHIPAADashboardScreen;