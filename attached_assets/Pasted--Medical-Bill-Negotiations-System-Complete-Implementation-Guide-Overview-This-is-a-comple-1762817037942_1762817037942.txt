# Medical Bill Negotiations System - Complete Implementation Guide

## ğŸ¯ Overview

This is a complete medical bill negotiation system that allows **Law Firms** and **Medical Providers** to negotiate medical bills for shared clients. The system includes:

- âœ… Real-time push notifications
- âœ… Back-and-forth counter offers
- âœ… Complete negotiation history logging
- âœ… "Call Me" feature for stalled negotiations
- âœ… Client-specific negotiations (both parties must share the same client)
- âœ… Individual clients are NOT shown this process

## ğŸ“ Files Created

1. **NegotiationsScreen.js** - Main React Native screen component
2. **backend-negotiations-routes.js** - Express.js API routes
3. **database-schema-negotiations.sql** - PostgreSQL database schema
4. **client-medical-provider-linking.js** - Schema and API for linking clients to providers
5. **negotiations-api-endpoints.js** - API endpoint definitions
6. **INTEGRATION_INSTRUCTIONS.md** - Step-by-step integration guide

## ğŸ—ï¸ Architecture

### Database Schema

```
negotiations
â”œâ”€â”€ id (Primary Key)
â”œâ”€â”€ client_id (Foreign Key â†’ clients)
â”œâ”€â”€ law_firm_id (Foreign Key â†’ law_firms)
â”œâ”€â”€ medical_provider_id (Foreign Key â†’ medical_providers)
â”œâ”€â”€ bill_description
â”œâ”€â”€ bill_amount
â”œâ”€â”€ current_offer
â”œâ”€â”€ status (pending, counter_offered, accepted, stalled)
â”œâ”€â”€ initiated_by (law_firm or medical_provider)
â”œâ”€â”€ last_responded_by
â””â”€â”€ timestamps

negotiation_history
â”œâ”€â”€ id (Primary Key)
â”œâ”€â”€ negotiation_id (Foreign Key â†’ negotiations)
â”œâ”€â”€ action_type (initiated, counter_offer, accepted, call_requested)
â”œâ”€â”€ action_by (law_firm or medical_provider)
â”œâ”€â”€ amount
â”œâ”€â”€ notes
â”œâ”€â”€ phone_number (for call requests)
â””â”€â”€ timestamp

client_medical_providers (linking table)
â”œâ”€â”€ id (Primary Key)
â”œâ”€â”€ client_id (Foreign Key â†’ clients)
â”œâ”€â”€ medical_provider_id (Foreign Key â†’ medical_providers)
â”œâ”€â”€ relationship_type
â”œâ”€â”€ is_active
â””â”€â”€ timestamps
```

### API Endpoints

```
GET    /api/negotiations                    - List all negotiations for user
POST   /api/negotiations/initiate           - Start new negotiation
POST   /api/negotiations/counter-offer      - Send counter offer
POST   /api/negotiations/accept             - Accept current offer
POST   /api/negotiations/request-call       - Request phone call
GET    /api/negotiations/:id/log            - Download negotiation log
GET    /api/clients/:id/medical-providers   - Get providers for client
POST   /api/clients/:id/link-medical-provider - Link client to provider
```

## ğŸš€ Setup Instructions

### Step 1: Database Setup

Run the SQL schema:

```bash
psql -U your_username -d your_database -f database-schema-negotiations.sql
```

Or copy the SQL from `database-schema-negotiations.sql` and run it in your PostgreSQL client.

### Step 2: Backend Setup

1. Copy `backend-negotiations-routes.js` to your backend `/routes` folder
2. Register the routes in your main server file:

```javascript
// server.js or app.js
const negotiationsRouter = require('./routes/negotiations');
app.use('/api/negotiations', negotiationsRouter);
```

3. Add client-provider linking routes from `client-medical-provider-linking.js`

### Step 3: Frontend Setup

1. Copy `NegotiationsScreen.js` to `/src/screens/`
2. Update your `App.js` with the integration code from `INTEGRATION_INSTRUCTIONS.md`
3. Add API endpoints to your `/src/config/api.js`

### Step 4: Update Dashboards

**Law Firm Dashboard:**
```jsx
<TouchableOpacity
  style={styles.menuButton}
  onPress={() => onNavigate('lawfirm-negotiations')}
>
  <Text style={styles.menuButtonIcon}>ğŸ’°</Text>
  <Text style={styles.menuButtonText}>Bill Negotiations</Text>
</TouchableOpacity>
```

**Medical Provider Dashboard:**
```jsx
<TouchableOpacity
  style={styles.menuButton}
  onPress={() => onNavigate('medicalprovider-negotiations')}
>
  <Text style={styles.menuButtonIcon}>ğŸ’°</Text>
  <Text style={styles.menuButtonText}>Bill Negotiations</Text>
</TouchableOpacity>
```

## ğŸ® User Flow

### Initiating a Negotiation

1. **Law Firm** clicks "Bill Negotiations" in dashboard
2. Clicks "+ Start New Negotiation"
3. Selects a client from their client list
4. System loads all medical providers linked to that client
5. Selects the medical provider they want to negotiate with
6. Enters bill details:
   - Bill description
   - Original bill amount
   - Initial offer amount
   - Optional notes
7. Submits negotiation
8. **Medical Provider** receives push notification

### Counter Offer Process

1. Receiving party opens notification â†’ taken to negotiations screen
2. Views negotiation details and history
3. Can either:
   - **Accept** the current offer (ends negotiation)
   - **Send Counter Offer** with new amount and notes
   - **Request Call** if negotiations are stalled
4. If counter offer sent, other party receives push notification
5. Process repeats until one party accepts

### Call Request Feature

When negotiations stall:
1. Either party clicks "Request Call"
2. Enters their phone number and availability notes
3. Other party receives push notification with phone number
4. Negotiation status updates to "stalled"
5. Parties can discuss by phone and resume negotiation

### Accepting an Offer

1. Either party can accept the current offer
2. Confirmation dialog appears
3. Upon acceptance:
   - Negotiation status â†’ "accepted"
   - Both parties receive push notification
   - Full negotiation log becomes available
   - Log includes:
     - All offers and counter-offers
     - Timestamps
     - Notes from both parties
     - Final agreed amount
     - Savings percentage

## ğŸ“± Push Notifications

The system sends notifications for:

- âœ… **Negotiation Initiated** - "A negotiation has been initiated for [bill description]"
- âœ… **Counter Offer Received** - "New counter offer of $X for [bill description]"
- âœ… **Offer Accepted** - "The negotiation for [bill] has been accepted at $X"
- âœ… **Call Requested** - "The other party would like to discuss. Call: [phone number]"
- âœ… **Negotiation Complete** - "Negotiation log available for [bill description]"

All notifications include deep links to open the negotiations screen directly.

## ğŸ”’ Security & Privacy

1. **Individual clients CANNOT see negotiations** - Feature is only accessible to law firms and medical providers
2. **Authorization checks** - Users can only view/modify negotiations they're involved in
3. **Client relationship validation** - Both parties must share the same client
4. **Data integrity** - Validation on all amounts and status transitions

## ğŸ’¡ Business Logic

### Validation Rules

- Initial offer must be less than bill amount
- Counter offers must be within valid range:
  - Law Firm: Can increase their offer (up to bill amount)
  - Medical Provider: Can decrease their minimum (down to current offer)
- All amounts must be positive numbers
- Phone numbers validated for call requests

### Status Flow

```
pending â†’ counter_offered â†’ counter_offered â†’ ... â†’ accepted
                     â†“
                  stalled (call requested)
                     â†“
              counter_offered (resumed)
```

## ğŸ“Š Negotiation Log

The log includes:

```json
{
  "negotiationId": 123,
  "clientName": "John Doe",
  "lawFirm": "Smith & Associates",
  "medicalProvider": "City Hospital",
  "billDescription": "Emergency Room Visit - 01/15/2025",
  "originalAmount": 5000.00,
  "finalAmount": 3500.00,
  "savingsAmount": 1500.00,
  "savingsPercentage": "30.00",
  "initiatedAt": "2025-01-15T10:00:00Z",
  "acceptedAt": "2025-01-20T15:30:00Z",
  "history": [
    {
      "action": "initiated",
      "actionBy": "law_firm",
      "amount": 3000.00,
      "notes": "Initial offer based on insurance coverage",
      "timestamp": "2025-01-15T10:00:00Z"
    },
    {
      "action": "counter_offer",
      "actionBy": "medical_provider",
      "amount": 4000.00,
      "notes": "This includes all emergency care costs",
      "timestamp": "2025-01-16T09:00:00Z"
    },
    {
      "action": "counter_offer",
      "actionBy": "law_firm",
      "amount": 3500.00,
      "notes": "Final offer",
      "timestamp": "2025-01-18T14:00:00Z"
    },
    {
      "action": "accepted",
      "actionBy": "medical_provider",
      "amount": 3500.00,
      "timestamp": "2025-01-20T15:30:00Z"
    }
  ]
}
```

## ğŸ”— Client-Provider Linking

Before negotiations can begin, clients must be linked to medical providers:

```javascript
// Link a client to a medical provider
POST /api/clients/:clientId/link-medical-provider
{
  "medicalProviderId": 456,
  "isPrimary": true
}

// Get all providers for a client
GET /api/clients/:clientId/medical-providers
```

This ensures:
- Law firms can only negotiate bills with providers their clients have visited
- Medical providers can only negotiate bills for their actual patients
- System maintains data integrity

## ğŸ¨ UI Features

### Negotiations List View
- Card-based layout
- Color-coded status badges
- "Your Turn" indicator
- Quick view of bill amount vs. current offer
- Sort by most recent activity

### Negotiation Detail View
- Full bill information
- Current offer highlighted
- Complete history timeline
- Action buttons (Accept, Counter Offer, Request Call)
- Download log button (when accepted)

### Modals
- **New Negotiation** - Step-by-step form
- **Counter Offer** - Simple amount + notes
- **Call Request** - Phone number + availability

## ğŸ› Testing Checklist

- [ ] Law firm can initiate negotiation
- [ ] Medical provider can initiate negotiation
- [ ] Push notifications received by both parties
- [ ] Counter offers work in both directions
- [ ] Validation prevents invalid amounts
- [ ] Accept offer works and triggers notifications
- [ ] Call request sends phone number
- [ ] Negotiation log available after acceptance
- [ ] Individual clients cannot access negotiations
- [ ] Authorization prevents unauthorized access
- [ ] Client-provider linking works correctly

## ğŸ“ Notes for Replit Deployment

1. Make sure your PostgreSQL database is running
2. Environment variables needed:
   - `DATABASE_URL` - PostgreSQL connection string
   - `EXPO_PUBLIC_API_URL` - Your backend API URL
3. Push notification configuration:
   - Ensure `NotificationService` is properly configured
   - Test on physical devices (push notifications don't work in simulators)

## ğŸ‰ Features Summary

âœ… Law firms and medical providers can negotiate bills
âœ… Real-time push notifications for all actions
âœ… Back-and-forth counter offers with full history
âœ… "Call Me" button with phone number for stalled negotiations
âœ… Client-specific (both parties must share the same client)
âœ… Complete communication log available after acceptance
âœ… Individual clients don't see the negotiation process
âœ… Professional UI with status indicators and badges
âœ… Mobile-responsive design
âœ… Authorization and security checks
âœ… Data validation and integrity

## ğŸ†˜ Support

If you encounter issues:
1. Check database schema is properly installed
2. Verify API endpoints are registered in server
3. Ensure push notification service is configured
4. Check client-provider relationships are established
5. Review backend logs for error messages

---

**Ready to deploy!** Follow the integration instructions and you'll have a fully functional medical bill negotiation system. ğŸš€