-- SQL Schema for Negotiations System
-- Add this to your existing database

-- Negotiations table - stores the main negotiation records
CREATE TABLE negotiations (
  id SERIAL PRIMARY KEY,
  
  -- Client/Patient being negotiated for
  client_id INTEGER NOT NULL REFERENCES clients(id) ON DELETE CASCADE,
  
  -- Parties involved
  law_firm_id INTEGER NOT NULL REFERENCES law_firms(id) ON DELETE CASCADE,
  medical_provider_id INTEGER NOT NULL REFERENCES medical_providers(id) ON DELETE CASCADE,
  
  -- Bill information
  bill_description TEXT NOT NULL,
  bill_amount DECIMAL(10, 2) NOT NULL,
  
  -- Current state
  current_offer DECIMAL(10, 2) NOT NULL,
  status VARCHAR(50) NOT NULL DEFAULT 'pending', -- pending, counter_offered, accepted, stalled
  
  -- Tracking
  initiated_by VARCHAR(50) NOT NULL, -- 'law_firm' or 'medical_provider'
  last_responded_by VARCHAR(50), -- 'law_firm' or 'medical_provider' or NULL
  
  -- Timestamps
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  accepted_at TIMESTAMP,
  
  -- Constraints
  CONSTRAINT positive_amounts CHECK (bill_amount > 0 AND current_offer >= 0),
  CONSTRAINT valid_offer CHECK (current_offer <= bill_amount)
);

-- Negotiation history table - stores all offers and counter-offers
CREATE TABLE negotiation_history (
  id SERIAL PRIMARY KEY,
  negotiation_id INTEGER NOT NULL REFERENCES negotiations(id) ON DELETE CASCADE,
  
  -- Action details
  action_type VARCHAR(50) NOT NULL, -- 'initiated', 'counter_offer', 'accepted', 'call_requested'
  action_by VARCHAR(50) NOT NULL, -- 'law_firm' or 'medical_provider'
  amount DECIMAL(10, 2),
  notes TEXT,
  
  -- For call requests
  phone_number VARCHAR(20),
  
  -- Timestamp
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  -- Index for fast lookups
  INDEX idx_negotiation_id (negotiation_id)
);

-- Indexes for performance
CREATE INDEX idx_negotiations_client ON negotiations(client_id);
CREATE INDEX idx_negotiations_law_firm ON negotiations(law_firm_id);
CREATE INDEX idx_negotiations_medical_provider ON negotiations(medical_provider_id);
CREATE INDEX idx_negotiations_status ON negotiations(status);
CREATE INDEX idx_negotiations_updated ON negotiations(updated_at DESC);

-- Trigger to update updated_at timestamp
CREATE OR REPLACE FUNCTION update_negotiation_timestamp()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = CURRENT_TIMESTAMP;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_negotiations_timestamp
BEFORE UPDATE ON negotiations
FOR EACH ROW
EXECUTE FUNCTION update_negotiation_timestamp();

-- View for easy querying with joined data
CREATE VIEW negotiations_with_details AS
SELECT 
  n.*,
  c.first_name || ' ' || c.last_name AS client_name,
  c.email AS client_email,
  lf.firm_name,
  lf.email AS law_firm_email,
  mp.provider_name,
  mp.email AS medical_provider_email,
  (
    SELECT COUNT(*) 
    FROM negotiation_history nh 
    WHERE nh.negotiation_id = n.id
  ) AS interaction_count,
  (
    SELECT json_agg(
      json_build_object(
        'action', nh.action_type,
        'actionBy', nh.action_by,
        'amount', nh.amount,
        'notes', nh.notes,
        'phoneNumber', nh.phone_number,
        'timestamp', nh.created_at
      ) ORDER BY nh.created_at DESC
    )
    FROM negotiation_history nh
    WHERE nh.negotiation_id = n.id
  ) AS history
FROM negotiations n
JOIN clients c ON n.client_id = c.id
JOIN law_firms lf ON n.law_firm_id = lf.id
JOIN medical_providers mp ON n.medical_provider_id = mp.id;